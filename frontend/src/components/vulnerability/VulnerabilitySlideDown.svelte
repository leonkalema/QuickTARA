<script lang="ts">
  import { ShieldAlert, AlertTriangle, AlertOctagon } from '@lucide/svelte';
  import { VulnerabilitySeverity, type Vulnerability } from '../../api/vulnerability';
  import Spinner from '../ui/Spinner.svelte';
  
  export let componentId: string;
  export let componentName: string;
  export let vulnerabilities: Vulnerability[] = [];
  export let isLoading: boolean = false;
  
  function getSeverityColor(severity: VulnerabilitySeverity): string {
    switch (severity) {
      case VulnerabilitySeverity.CRITICAL:
        return 'text-red-700 bg-red-100';
      case VulnerabilitySeverity.HIGH:
        return 'text-orange-700 bg-orange-100';
      case VulnerabilitySeverity.MEDIUM:
        return 'text-yellow-700 bg-yellow-100';
      case VulnerabilitySeverity.LOW:
        return 'text-green-700 bg-green-100';
      default:
        return 'text-gray-700 bg-gray-100';
    }
  }
  
  function getSeverityIcon(severity: VulnerabilitySeverity) {
    switch (severity) {
      case VulnerabilitySeverity.CRITICAL:
        return AlertOctagon;
      case VulnerabilitySeverity.HIGH:
        return ShieldAlert;
      case VulnerabilitySeverity.MEDIUM:
        return AlertTriangle;
      default:
        return AlertTriangle;
    }
  }
</script>

<div class="w-full bg-gray-50 p-4 border-t border-gray-200 animate-slide-down">
  <div class="mx-auto">
    <div class="mb-3 pb-2 border-b border-gray-200">
      <h3 class="text-lg font-medium leading-6 text-gray-900">
        Component Vulnerabilities
      </h3>
      <p class="mt-1 text-sm text-gray-500">
        {componentName} (ID: {componentId})
      </p>
    </div>

    <div class="py-2">
      {#if isLoading}
        <div class="flex justify-center py-6">
          <Spinner size="md" />
        </div>
      {:else if vulnerabilities.length === 0}
        <div class="text-center py-6">
          <ShieldAlert class="mx-auto h-12 w-12 text-gray-400" />
          <h3 class="mt-2 text-sm font-medium text-gray-900">No Vulnerabilities Found</h3>
          <p class="mt-1 text-sm text-gray-500">
            No vulnerabilities were identified for this component.
          </p>
        </div>
      {:else}
        <div class="space-y-6">
          {#each vulnerabilities as vulnerability}
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
              <!-- Vulnerability header -->
              <div class="px-4 py-4 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    {#if vulnerability.severity}
                      <span class={`flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getSeverityColor(vulnerability.severity)}`}>
                        <svelte:component this={getSeverityIcon(vulnerability.severity)} class="h-4 w-4 mr-1" />
                        {vulnerability.severity}
                      </span>
                    {/if}
                    <h4 class="ml-2 text-sm font-medium text-gray-900">
                      {vulnerability.name || 'Unnamed Vulnerability'}
                    </h4>
                  </div>
                  {#if vulnerability.cvss_score}
                    <div>
                      <span class="text-sm font-medium text-gray-500">CVSS: </span>
                      <span class="text-sm font-medium text-gray-900">{vulnerability.cvss_score}</span>
                    </div>
                  {/if}
                </div>
              </div>
              
              <!-- Vulnerability details -->
              <div class="px-4 py-4">
                {#if vulnerability.description}
                  <div class="mb-4">
                    <h5 class="text-sm font-medium text-gray-500 mb-1">Description</h5>
                    <p class="text-sm text-gray-900">{vulnerability.description}</p>
                  </div>
                {/if}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Attack Vector Details -->
                  <div>
                    <h5 class="text-sm font-medium text-gray-500 mb-2">Attack Details</h5>
                    <dl class="space-y-1">
                      {#if vulnerability.attack_vector}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Attack Vector:</dt>
                          <dd class="text-gray-900">{vulnerability.attack_vector}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.attack_complexity}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Attack Complexity:</dt>
                          <dd class="text-gray-900">{vulnerability.attack_complexity}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.privileges_required}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Privileges Required:</dt>
                          <dd class="text-gray-900">{vulnerability.privileges_required}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.user_interaction}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">User Interaction:</dt>
                          <dd class="text-gray-900">{vulnerability.user_interaction}</dd>
                        </div>
                      {/if}
                    </dl>
                  </div>
                  
                  <!-- Impact Details -->
                  <div>
                    <h5 class="text-sm font-medium text-gray-500 mb-2">Impact</h5>
                    <dl class="space-y-1">
                      {#if vulnerability.confidentiality_impact}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Confidentiality:</dt>
                          <dd class="text-gray-900">{vulnerability.confidentiality_impact}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.integrity_impact}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Integrity:</dt>
                          <dd class="text-gray-900">{vulnerability.integrity_impact}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.availability_impact}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Availability:</dt>
                          <dd class="text-gray-900">{vulnerability.availability_impact}</dd>
                        </div>
                      {/if}
                      {#if vulnerability.scope}
                        <div class="flex justify-between text-sm">
                          <dt class="text-gray-500">Scope:</dt>
                          <dd class="text-gray-900">{vulnerability.scope}</dd>
                        </div>
                      {/if}
                    </dl>
                  </div>
                </div>
                
                {#if vulnerability.cvss_vector}
                  <div class="mt-4">
                    <h5 class="text-sm font-medium text-gray-500 mb-1">CVSS Vector</h5>
                    <code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-800">
                      {vulnerability.cvss_vector}
                    </code>
                  </div>
                {/if}
              </div>
            </div>
          {/each}
        </div>
      {/if}
    </div>
  </div>
</div>

<style>
  /* Animation for slide down effect */
  @keyframes slideDown {
    from {
      max-height: 0;
      opacity: 0;
    }
    to {
      max-height: 2000px;
      opacity: 1;
    }
  }
  
  .animate-slide-down {
    animation: slideDown 0.3s ease-in-out;
    overflow: hidden;
  }
</style>
