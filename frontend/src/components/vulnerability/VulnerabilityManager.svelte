<script lang="ts">
  import { onMount } from 'svelte';
  import { 
    getVulnerabilities, 
    deleteVulnerability, 
    type Vulnerability, 
    VulnerabilitySeverity
  } from '../../api/vulnerability';
  import { showNotification } from '../../stores/notification';
  import Spinner from '../ui/Spinner.svelte';
  import Modal from '../ui/Modal.svelte';
  import VulnerabilityForm from './VulnerabilityForm.svelte';
  import VulnerabilityDetails from './VulnerabilityDetails.svelte';
  import { fade } from 'svelte/transition';
  
  // State variables
  let vulnerabilities: Vulnerability[] = [];
  let loading = true;
  let error = '';
  let selectedVulnerabilityId: string | null = null;
  let vulnerabilityToDelete: Vulnerability | null = null;
  let showDeleteConfirmation = false;
  let showCreateForm = false;
  let showEditForm = false;
  let showDetails = false;
  let filterBySeverity: string = '';

  // Severity display names
  const severityNames = {
    [VulnerabilitySeverity.LOW]: 'Low',
    [VulnerabilitySeverity.MEDIUM]: 'Medium',
    [VulnerabilitySeverity.HIGH]: 'High',
    [VulnerabilitySeverity.CRITICAL]: 'Critical'
  };
  
  // Severity color classes
  const severityColors = {
    [VulnerabilitySeverity.LOW]: 'bg-blue-100 text-blue-800',
    [VulnerabilitySeverity.MEDIUM]: 'bg-yellow-100 text-yellow-800',
    [VulnerabilitySeverity.HIGH]: 'bg-orange-100 text-orange-800',
    [VulnerabilitySeverity.CRITICAL]: 'bg-red-100 text-red-800'
  };
  
  // Functions
  function handleCreateClick() {
    showCreateForm = true;
  }
  
  function handleEditClick(item: Vulnerability) {
    selectedVulnerabilityId = item.vulnerability_id;
    showEditForm = true;
  }
  
  function handleViewClick(item: Vulnerability) {
    selectedVulnerabilityId = item.vulnerability_id;
    showDetails = true;
  }
  
  function handleDeleteClick(item: Vulnerability) {
    vulnerabilityToDelete = item;
    showDeleteConfirmation = true;
  }


  
  function closeModals() {
    showCreateForm = false;
    showEditForm = false;
    showDetails = false;
    showDeleteConfirmation = false;
    selectedVulnerabilityId = null;
    vulnerabilityToDelete = null;
  }
  
  async function confirmDelete() {
    if (vulnerabilityToDelete) {
      try {
        await deleteVulnerability(vulnerabilityToDelete.vulnerability_id);
        showNotification('Vulnerability deleted successfully', 'success');
        vulnerabilities = vulnerabilities.filter(item => item.vulnerability_id !== vulnerabilityToDelete?.vulnerability_id);
        closeModals();
      } catch (err) {
        console.error('Error deleting vulnerability:', err);
        showNotification('Failed to delete vulnerability', 'error');
      }
    }
  }
  
  async function loadVulnerabilities() {
    loading = true;
    error = '';
    
    try {
      // Use the API client
      const result = await getVulnerabilities(0, 100);
      console.log('API client response:', result);
      
      // Handle different possible response formats
      if (result && result.vulnerabilities && Array.isArray(result.vulnerabilities)) {
        vulnerabilities = result.vulnerabilities;
      } else if (Array.isArray(result)) {
        vulnerabilities = result;
      } else if (result && typeof result === 'object') {
        // Try to find an array property in the response object
        const arrayProps = Object.entries(result)
          .filter(([_, value]) => Array.isArray(value))
          .map(([key, value]) => ({ key, value }));
          
        if (arrayProps.length > 0) {
          // Use the first array property found
          vulnerabilities = arrayProps[0].value;
        } else {
          // No valid data found
          vulnerabilities = [];
          error = 'Unexpected response format from API';
        }
      } else {
        vulnerabilities = [];
        error = 'Failed to load vulnerabilities';
      }

      // Filter out any null/undefined items
      vulnerabilities = vulnerabilities.filter(item => item && item.vulnerability_id != null);
      console.log('Final processed vulnerabilities:', vulnerabilities);
    } catch (err) {
      console.error('Error loading vulnerabilities:', err);
      error = 'Failed to load vulnerabilities';
      showNotification('Failed to load vulnerabilities', 'error');
    } finally {
      loading = false;
    }
  }

  function handleVulnerabilityCreated(event: CustomEvent<Vulnerability>) {
    const newVulnerability = event.detail;
    vulnerabilities = [...vulnerabilities, newVulnerability];
    closeModals();
  }
  
  function handleVulnerabilityUpdated(event: CustomEvent<Vulnerability>) {
    const updatedVulnerability = event.detail;
    vulnerabilities = vulnerabilities.map(item => 
      item.vulnerability_id === updatedVulnerability.vulnerability_id ? updatedVulnerability : item
    );
    closeModals();
  }

  // Computed values
  $: filteredVulnerabilities = filterBySeverity
    ? vulnerabilities.filter(item => item && item.severity === filterBySeverity) 
    : vulnerabilities.filter(item => item !== null && item !== undefined);
  
  // Load items on mount
  onMount(() => {
    loadVulnerabilities();
  });
</script>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-semibold mb-6">Vulnerability Management</h1>
  
  <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div class="w-full sm:w-auto">
      <label for="severityFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Severity</label>
      <select
        id="severityFilter"
        bind:value={filterBySeverity}
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
      >
        <option value="">All Severities</option>
        <option value={VulnerabilitySeverity.LOW}>Low</option>
        <option value={VulnerabilitySeverity.MEDIUM}>Medium</option>
        <option value={VulnerabilitySeverity.HIGH}>High</option>
        <option value={VulnerabilitySeverity.CRITICAL}>Critical</option>
      </select>
    </div>
    
    <div class="flex gap-2">
      <button
        on:click={handleCreateClick}
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
        Add New Vulnerability
      </button>
    </div>
  </div>
  
  {#if loading}
    <div class="flex justify-center py-12">
      <Spinner size="lg" />
    </div>
  {:else if error}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
      <strong class="font-bold">Error!</strong>
      <span class="block sm:inline"> {error}</span>
    </div>
    
    <div class="text-center py-8">
      <div class="mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No vulnerabilities found</h3>
      <p class="mt-1 text-sm text-gray-500">Get started by creating a new vulnerability.</p>
      <div class="mt-6">
        <button
          on:click={handleCreateClick}
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          Create First Vulnerability
        </button>
      </div>
    </div>
  {:else if vulnerabilities.length === 0}
    <div class="text-center py-8">
      <div class="mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
        </svg>
      </div>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No vulnerabilities found</h3>
      <p class="mt-1 text-sm text-gray-500">Get started by creating a new vulnerability.</p>
      <div class="mt-6 flex justify-center">
        <button
          on:click={handleCreateClick}
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v5H4a1 1 0 100 2h5v5a1 1 0 102 0v-5h5a1 1 0 100-2h-5V4a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          Create Vulnerability
        </button>
      </div>
    </div>
  {:else}
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVSS Score</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Affected Components</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {#each filteredVulnerabilities as item (item?.vulnerability_id || Math.random().toString(36))}
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{item?.name || 'Unnamed'}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {severityColors[item?.severity] || 'bg-gray-100 text-gray-800'}">
                  {severityNames[item?.severity] || 'Unknown'}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="h-2 w-16 bg-gray-200 rounded overflow-hidden">
                    <div 
                      class="h-full {item?.cvss_score && item.cvss_score >= 7.0 ? 'bg-red-500' : item?.cvss_score && item.cvss_score >= 4.0 ? 'bg-yellow-500' : 'bg-blue-500'}" 
                      style="width: {item?.cvss_score ? (item.cvss_score * 10) + '%' : '0%'}"
                    ></div>
                  </div>
                  <span class="ml-2 text-sm text-gray-700">{item?.cvss_score?.toFixed(1) || 'N/A'}</span>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">
                  {#if item?.affected_components && item.affected_components.length > 0}
                    <div class="flex flex-wrap gap-1">
                      {#each item.affected_components.slice(0, 3) as component}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                          {component}
                        </span>
                      {/each}
                      {#if item.affected_components.length > 3}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                          +{item.affected_components.length - 3} more
                        </span>
                      {/if}
                    </div>
                  {:else}
                    <span class="text-gray-500">None</span>
                  {/if}
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex space-x-2">
                  <button 
                    on:click={() => handleViewClick(item)} 
                    class="text-blue-600 hover:text-blue-900"
                    title="View details"
                    aria-label="View vulnerability details"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  <button 
                    on:click={() => handleEditClick(item)} 
                    class="text-yellow-600 hover:text-yellow-900"
                    title="Edit"
                    aria-label="Edit vulnerability"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                    </svg>
                  </button>
                  <button 
                    on:click={() => handleDeleteClick(item)} 
                    class="text-red-600 hover:text-red-900"
                    title="Delete"
                    aria-label="Delete vulnerability"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          {/each}
        </tbody>
      </table>
    </div>
  {/if}
  
  <!-- Create Vulnerability Modal -->
  {#if showCreateForm}
    <Modal on:close={closeModals} title="Create New Vulnerability">
      <VulnerabilityForm on:created={handleVulnerabilityCreated} on:cancel={closeModals} />
    </Modal>
  {/if}
  
  <!-- Edit Vulnerability Modal -->
  {#if showEditForm && selectedVulnerabilityId}
    <Modal on:close={closeModals} title="Edit Vulnerability">
      <VulnerabilityForm 
        vulnerabilityId={selectedVulnerabilityId} 
        mode="edit" 
        on:updated={handleVulnerabilityUpdated} 
        on:cancel={closeModals} 
      />
    </Modal>
  {/if}
  
  <!-- View Vulnerability Details Modal -->
  {#if showDetails && selectedVulnerabilityId}
    <Modal on:close={closeModals} title="Vulnerability Details">
      <VulnerabilityDetails 
        vulnerabilityId={selectedVulnerabilityId} 
        on:edit={() => {
          showDetails = false;
          showEditForm = true;
        }} 
        on:close={closeModals} 
      />
    </Modal>
  {/if}


  
  <!-- Delete Confirmation Modal -->
  {#if showDeleteConfirmation && vulnerabilityToDelete}
    <Modal on:close={closeModals} title="Confirm Deletion">
      <div class="p-6">
        <p class="mb-4">Are you sure you want to delete the vulnerability "{vulnerabilityToDelete.name}"?</p>
        <p class="mb-6 text-red-600 text-sm">This action cannot be undone.</p>
        
        <div class="flex justify-end space-x-3">
          <button 
            on:click={closeModals}
            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md"
          >
            Cancel
          </button>
          <button 
            on:click={confirmDelete}
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md"
          >
            Delete
          </button>
        </div>
      </div>
    </Modal>
  {/if}
</div>
