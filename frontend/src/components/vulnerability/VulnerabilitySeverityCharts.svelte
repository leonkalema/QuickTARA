<script lang="ts">
  import { onMount, onDestroy } from 'svelte';
  import { Chart, registerables } from 'chart.js';
  import { VulnerabilitySeverity, type Vulnerability } from '../../api/vulnerability';
  
  // Register Chart.js components
  Chart.register(...registerables);

  // Props
  export let assessmentResult: any; // Assessment result data
  export let selectedComponentId: string | null = null;
  export let vulnerabilities: Vulnerability[] = [];
  
  // DOM references for charts
  let severityDistributionCanvas: HTMLCanvasElement;
  let componentSeverityCanvas: HTMLCanvasElement;
  let severityTrendCanvas: HTMLCanvasElement;
  
  // Chart instances
  let severityDistributionChart: Chart;
  let componentSeverityChart: Chart;
  let severityTrendChart: Chart;
  
  // Computed data
  $: severityDistributionData = getSeverityDistribution(assessmentResult);
  $: componentSeverityData = getComponentSeverityData(assessmentResult);
  $: componentVulnerabilitiesData = getComponentVulnerabilitiesData(vulnerabilities);
  
  // Theme colors to match the app's look and feel
  const chartColors = {
    critical: 'rgba(220, 38, 38, 0.8)', // red-600
    high: 'rgba(234, 88, 12, 0.8)',     // orange-600
    medium: 'rgba(234, 179, 8, 0.8)',   // yellow-500
    low: 'rgba(22, 163, 74, 0.8)',      // green-600
    background: '#F0F2E6',              // background color from theme
    text: '#444444',                    // text color
    gridLines: 'rgba(107, 114, 128, 0.2)' // gray-500 with opacity
  };
  
  // Process assessment data for severity distribution chart (pie chart)
  function getSeverityDistribution(assessment: any) {
    if (!assessment?.component_assessments) return null;
    
    // Count vulnerabilities by severity
    let criticalCount = 0;
    let highCount = assessment.high_severity_vulnerabilities || 0;
    let mediumCount = 0;
    let lowCount = 0;
    
    // If we have detailed vulnerability data, calculate exact counts
    if (vulnerabilities.length > 0) {
      criticalCount = vulnerabilities.filter(v => v.severity === VulnerabilitySeverity.CRITICAL).length;
      highCount = vulnerabilities.filter(v => v.severity === VulnerabilitySeverity.HIGH).length;
      mediumCount = vulnerabilities.filter(v => v.severity === VulnerabilitySeverity.MEDIUM).length;
      lowCount = vulnerabilities.filter(v => v.severity === VulnerabilitySeverity.LOW).length;
    } else {
      // Otherwise estimate based on assessment data
      const totalVulns = assessment.total_vulnerabilities || 0;
      const remaining = totalVulns - highCount;
      // Estimate distribution for remaining vulnerabilities
      mediumCount = Math.round(remaining * 0.6); // Assume 60% are medium
      lowCount = remaining - mediumCount;        // Rest are low
    }
    
    return {
      labels: ['Critical', 'High', 'Medium', 'Low'],
      datasets: [{
        data: [criticalCount, highCount, mediumCount, lowCount],
        backgroundColor: [
          chartColors.critical,
          chartColors.high,
          chartColors.medium,
          chartColors.low
        ],
        borderWidth: 1
      }]
    };
  }
  
  // Process data for component severity bar chart
  function getComponentSeverityData(assessment: any) {
    if (!assessment?.component_assessments) return null;
    
    // Get top 5 components with most high-severity vulnerabilities
    const sortedComponents = [...assessment.component_assessments]
      .sort((a, b) => b.high_severity_vulnerabilities - a.high_severity_vulnerabilities)
      .slice(0, 5);
    
    return {
      labels: sortedComponents.map(c => c.component_name),
      datasets: [
        {
          label: 'High Severity',
          data: sortedComponents.map(c => c.high_severity_vulnerabilities),
          backgroundColor: chartColors.high,
        },
        {
          label: 'Total Vulnerabilities',
          data: sortedComponents.map(c => c.total_vulnerabilities),
          backgroundColor: chartColors.medium,
        }
      ]
    };
  }
  
  // Process vulnerability data for selected component
  function getComponentVulnerabilitiesData(vulnerabilities: Vulnerability[]) {
    if (!vulnerabilities.length) return null;
    
    // Group vulnerabilities by impact categories
    const confidentialityImpacts: Record<string, number> = vulnerabilities.reduce((acc: Record<string, number>, v) => {
      if (!v.confidentiality_impact) return acc;
      const impact = v.confidentiality_impact;
      acc[impact] = (acc[impact] || 0) + 1;
      return acc;
    }, {});
    
    const integrityImpacts: Record<string, number> = vulnerabilities.reduce((acc: Record<string, number>, v) => {
      if (!v.integrity_impact) return acc;
      const impact = v.integrity_impact;
      acc[impact] = (acc[impact] || 0) + 1;
      return acc;
    }, {});
    
    const availabilityImpacts: Record<string, number> = vulnerabilities.reduce((acc: Record<string, number>, v) => {
      if (!v.availability_impact) return acc;
      const impact = v.availability_impact;
      acc[impact] = (acc[impact] || 0) + 1;
      return acc;
    }, {});
    
    return {
      labels: ['None', 'Low', 'High'],
      datasets: [
        {
          label: 'Confidentiality',
          data: [
            confidentialityImpacts['None'] || 0,
            confidentialityImpacts['Low'] || 0,
            confidentialityImpacts['High'] || 0
          ],
          backgroundColor: 'rgba(59, 130, 246, 0.7)' // blue
        },
        {
          label: 'Integrity',
          data: [
            integrityImpacts['None'] || 0,
            integrityImpacts['Low'] || 0,
            integrityImpacts['High'] || 0
          ],
          backgroundColor: 'rgba(139, 92, 246, 0.7)' // purple
        },
        {
          label: 'Availability',
          data: [
            availabilityImpacts['None'] || 0,
            availabilityImpacts['Low'] || 0,
            availabilityImpacts['High'] || 0
          ],
          backgroundColor: 'rgba(16, 185, 129, 0.7)' // emerald
        }
      ]
    } as const;
  }
  
  // Initialize charts when component mounts
  onMount(() => {
    initializeCharts();
  });
  
  // Clean up charts when component is destroyed
  onDestroy(() => {
    if (severityDistributionChart) severityDistributionChart.destroy();
    if (componentSeverityChart) componentSeverityChart.destroy();
    if (severityTrendChart) severityTrendChart.destroy();
  });
  
  // Update charts when data changes
  $: if (severityDistributionData && severityDistributionChart) {
    severityDistributionChart.data = severityDistributionData as any;
    severityDistributionChart.update();
  }
  
  $: if (componentSeverityData && componentSeverityChart) {
    componentSeverityChart.data = componentSeverityData as any;
    componentSeverityChart.update();
  }
  
  $: if (componentVulnerabilitiesData && severityTrendChart) {
    severityTrendChart.data = componentVulnerabilitiesData as any;
    severityTrendChart.update();
  }
  
  // Initialize all charts
  function initializeCharts() {
    // Configure text style for all charts
    Chart.defaults.color = chartColors.text;
    Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
    
    // Only create charts if data and DOM elements are available
    if (severityDistributionData && severityDistributionCanvas) {
      initSeverityDistributionChart();
    }
    
    if (componentSeverityData && componentSeverityCanvas) {
      initComponentSeverityChart();
    }
    
    if (componentVulnerabilitiesData && severityTrendCanvas) {
      initImpactCategoryChart();
    }
  }
  
  // Initialize severity distribution pie chart
  function initSeverityDistributionChart() {
    if (severityDistributionChart) severityDistributionChart.destroy();
    
    severityDistributionChart = new Chart(severityDistributionCanvas, {
      type: 'doughnut',
      data: severityDistributionData as any,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Vulnerability Severity Distribution',
            font: {
              size: 16,
              weight: 'normal'
            }
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  // Initialize component severity bar chart
  function initComponentSeverityChart() {
    if (componentSeverityChart) componentSeverityChart.destroy();
    
    componentSeverityChart = new Chart(componentSeverityCanvas, {
      type: 'bar',
      data: componentSeverityData as any,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: false,
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: chartColors.gridLines
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Top 5 Components by Vulnerability Severity',
            font: {
              size: 16,
              weight: 'normal'
            }
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  // Initialize impact category chart
  function initImpactCategoryChart() {
    if (severityTrendChart) severityTrendChart.destroy();
    
    severityTrendChart = new Chart(severityTrendCanvas, {
      type: 'bar',
      data: componentVulnerabilitiesData as any,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: chartColors.gridLines
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: selectedComponentId 
              ? 'Impact Categories for Selected Component' 
              : 'Vulnerability Impact Categories',
            font: {
              size: 16,
              weight: 'normal'
            }
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
</script>

<div class="space-y-6">
  <div class="flex justify-between items-center">
    <h3 class="text-lg font-medium" style="color: var(--color-text-main);">Vulnerability Analytics</h3>
    
    <!-- Component selector dropdown -->
    {#if assessmentResult?.component_assessments?.length > 0}
      <div class="relative">
        <select 
          class="block w-64 pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
          bind:value={selectedComponentId}
        >
          <option value={null}>All Components (Overview)</option>
          {#each assessmentResult.component_assessments as assessment}
            <option value={assessment.component_id}>{assessment.component_name}</option>
          {/each}
        </select>
      </div>
    {/if}
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Severity Distribution Chart -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4">
      <div class="h-64 relative">
        {#if !severityDistributionData}
          <div class="absolute inset-0 flex items-center justify-center">
            <p class="text-gray-500 text-sm">No vulnerability data available</p>
          </div>
        {:else}
          <canvas bind:this={severityDistributionCanvas}></canvas>
        {/if}
      </div>
    </div>
    
    <!-- Component Severity Chart -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4">
      <div class="h-64 relative">
        {#if !componentSeverityData}
          <div class="absolute inset-0 flex items-center justify-center">
            <p class="text-gray-500 text-sm">No component data available</p>
          </div>
        {:else}
          <canvas bind:this={componentSeverityCanvas}></canvas>
        {/if}
      </div>
    </div>
    
    <!-- Impact Category Chart -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 lg:col-span-2">
      <div class="h-64 relative">
        {#if !componentVulnerabilitiesData}
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
              <p class="text-gray-500 text-sm">
                {#if selectedComponentId}
                  No vulnerability details available for the selected component
                {:else}
                  Select a component from the dropdown above to view impact details
                {/if}
              </p>
            </div>
          </div>
        {:else}
          <div class="mb-2 text-sm text-gray-500">
            {#if selectedComponentId}
              <p>Showing impact details for: <span class="font-medium">{assessmentResult?.component_assessments?.find((a: any) => a.component_id === selectedComponentId)?.component_name || 'Selected Component'}</span></p>
            {:else}
              <p>Showing aggregated impact details for all components</p>
            {/if}
          </div>
          <canvas bind:this={severityTrendCanvas}></canvas>
        {/if}
      </div>
    </div>
  </div>
</div>
