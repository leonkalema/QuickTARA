<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  import { XCircle, ShieldAlert, AlertTriangle, AlertOctagon } from '@lucide/svelte';
  import { VulnerabilitySeverity, type Vulnerability } from '../../api/vulnerability';
  import Spinner from '../ui/Spinner.svelte';
  
  export let componentId: string;
  export let componentName: string;
  export let vulnerabilities: Vulnerability[] = [];
  export let isLoading: boolean = false;
  
  const dispatch = createEventDispatcher();
  
  function close() {
    dispatch('close');
  }
  
  function getSeverityColor(severity: VulnerabilitySeverity): string {
    switch (severity) {
      case VulnerabilitySeverity.CRITICAL:
        return 'text-red-700 bg-red-100';
      case VulnerabilitySeverity.HIGH:
        return 'text-orange-700 bg-orange-100';
      case VulnerabilitySeverity.MEDIUM:
        return 'text-yellow-700 bg-yellow-100';
      case VulnerabilitySeverity.LOW:
        return 'text-green-700 bg-green-100';
      default:
        return 'text-gray-700 bg-gray-100';
    }
  }
  
  function getSeverityIcon(severity: VulnerabilitySeverity) {
    switch (severity) {
      case VulnerabilitySeverity.CRITICAL:
        return AlertOctagon;
      case VulnerabilitySeverity.HIGH:
        return ShieldAlert;
      case VulnerabilitySeverity.MEDIUM:
        return AlertTriangle;
      default:
        return AlertTriangle;
    }
  }
</script>

<!-- Modal backdrop -->
<div 
  class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-40"
  on:click={close}
></div>

<!-- Modal panel -->
<div class="fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
    <div 
      class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl"
      on:click|stopPropagation
    >
      <!-- Modal header -->
      <div class="bg-gray-50 px-4 py-4 sm:px-6 flex items-center justify-between border-b border-gray-200">
        <div>
          <h3 class="text-lg font-medium leading-6 text-gray-900">
            Component Vulnerabilities
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            {componentName} (ID: {componentId})
          </p>
        </div>
        <button
          type="button"
          class="rounded-md bg-gray-50 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          on:click={close}
        >
          <span class="sr-only">Close</span>
          <XCircle class="h-6 w-6" />
        </button>
      </div>

      <!-- Modal content -->
      <div class="px-4 py-5 sm:p-6 max-h-[70vh] overflow-y-auto">
        {#if isLoading}
          <div class="flex justify-center py-12">
            <Spinner size="md" />
          </div>
        {:else if vulnerabilities.length === 0}
          <div class="text-center py-12">
            <ShieldAlert class="mx-auto h-12 w-12 text-gray-400" />
            <h3 class="mt-2 text-sm font-medium text-gray-900">No Vulnerabilities Found</h3>
            <p class="mt-1 text-sm text-gray-500">
              No vulnerabilities were identified for this component.
            </p>
          </div>
        {:else}
          <div class="space-y-6">
            {#each vulnerabilities as vulnerability}
              <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                <!-- Vulnerability header -->
                <div class="px-4 py-4 bg-gray-50 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      {#if vulnerability.severity}
                        <span class={`flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getSeverityColor(vulnerability.severity)}`}>
                          <svelte:component this={getSeverityIcon(vulnerability.severity)} class="h-4 w-4 mr-1" />
                          {vulnerability.severity}
                        </span>
                      {/if}
                      <h4 class="ml-3 text-lg font-medium text-gray-900">
                        {vulnerability.name}
                      </h4>
                    </div>
                    {#if vulnerability.cvss_score}
                      <div class="flex items-center">
                        <span class="text-sm text-gray-500 mr-2">CVSS:</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-sm font-medium bg-gray-100 text-gray-800">
                          {vulnerability.cvss_score.toFixed(1)}
                        </span>
                      </div>
                    {/if}
                  </div>
                </div>
                
                <!-- Vulnerability details -->
                <div class="px-4 py-4">
                  {#if vulnerability.description}
                    <div class="mb-4">
                      <h5 class="text-sm font-medium text-gray-500 mb-1">Description</h5>
                      <p class="text-sm text-gray-900">{vulnerability.description}</p>
                    </div>
                  {/if}
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Attack Vector Details -->
                    <div>
                      <h5 class="text-sm font-medium text-gray-500 mb-2">Attack Details</h5>
                      <dl class="space-y-1">
                        {#if vulnerability.attack_vector}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Attack Vector:</dt>
                            <dd class="text-gray-900">{vulnerability.attack_vector}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.attack_complexity}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Attack Complexity:</dt>
                            <dd class="text-gray-900">{vulnerability.attack_complexity}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.privileges_required}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Privileges Required:</dt>
                            <dd class="text-gray-900">{vulnerability.privileges_required}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.user_interaction}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">User Interaction:</dt>
                            <dd class="text-gray-900">{vulnerability.user_interaction}</dd>
                          </div>
                        {/if}
                      </dl>
                    </div>
                    
                    <!-- Impact Details -->
                    <div>
                      <h5 class="text-sm font-medium text-gray-500 mb-2">Impact</h5>
                      <dl class="space-y-1">
                        {#if vulnerability.confidentiality_impact}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Confidentiality:</dt>
                            <dd class="text-gray-900">{vulnerability.confidentiality_impact}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.integrity_impact}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Integrity:</dt>
                            <dd class="text-gray-900">{vulnerability.integrity_impact}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.availability_impact}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Availability:</dt>
                            <dd class="text-gray-900">{vulnerability.availability_impact}</dd>
                          </div>
                        {/if}
                        {#if vulnerability.scope}
                          <div class="flex justify-between text-sm">
                            <dt class="text-gray-500">Scope:</dt>
                            <dd class="text-gray-900">{vulnerability.scope}</dd>
                          </div>
                        {/if}
                      </dl>
                    </div>
                  </div>
                  
                  {#if vulnerability.cvss_vector}
                    <div class="mt-4">
                      <h5 class="text-sm font-medium text-gray-500 mb-1">CVSS Vector</h5>
                      <code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-800">
                        {vulnerability.cvss_vector}
                      </code>
                    </div>
                  {/if}
                </div>
              </div>
            {/each}
          </div>
        {/if}
      </div>

      <!-- Modal footer -->
      <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-200">
        <button
          type="button"
          class="inline-flex w-full justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm"
          on:click={close}
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
