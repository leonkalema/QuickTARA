<script lang="ts">
  import { onMount } from 'svelte';
  import { performVulnerabilityAssessment, getVulnerabilities, getVulnerability, type VulnerabilityAssessmentResult, type Vulnerability } from '../../api/vulnerability';
  import { getComponents } from '../../api/component';
  import { showNotification } from '../../stores/notification';
  import Spinner from '../ui/Spinner.svelte';
  import { ShieldAlert, AlertTriangle, ChevronRight, XCircle } from '@lucide/svelte';
  import VulnerabilitySlideDown from './VulnerabilitySlideDown.svelte';
  import VulnerabilitySeverityCharts from './VulnerabilitySeverityCharts.svelte';
  
  // State
  let availableComponents: { id: string; name: string; component_type: string }[] = [];
  let selectedComponentIds: string[] = [];
  let assessmentResult: VulnerabilityAssessmentResult | null = null;
  let loading = false;
  let isLoadingComponents = true;
  let error = '';
  let expandedComponentId: string | null = null;
  let componentVulnerabilities: Vulnerability[] = [];
  let isLoadingVulnerabilities = false;
  
  // Load components on mount
  onMount(async () => {
    try {
      const result = await getComponents();
      // Check if we received the expected format
      if (result && result.components && Array.isArray(result.components)) {
        // Map component_id to id to match the expected interface
        availableComponents = result.components.map(c => ({ 
          id: c.component_id || c.id, // Use component_id field from the API or fall back to id
          name: c.name,
          component_type: c.type || c.component_type // Use type field from the API or fall back to component_type
        }));
        console.log('Loaded components:', availableComponents);
      } else {
        console.error('Unexpected components response format:', result);
        error = 'Failed to parse components data';
      }
    } catch (err) {
      console.error('Error loading components:', err);
      error = 'Failed to load components';
    } finally {
      isLoadingComponents = false;
    }
  });
  
  // Run assessment
  async function runAssessment() {
    if (selectedComponentIds.length === 0) {
      showNotification('Please select at least one component to assess', 'warning');
      return;
    }
    
    loading = true;
    error = '';
    
    try {
      console.log('Running assessment with component IDs:', selectedComponentIds);
      assessmentResult = await performVulnerabilityAssessment(selectedComponentIds);
      
      // Log success for debugging
      console.log('Assessment completed successfully:', assessmentResult);
      
      showNotification('Vulnerability assessment completed successfully', 'success');
    } catch (err) {
      console.error('Error performing vulnerability assessment:', err);
      
      // Get error message
      let errorMessage = 'Failed to perform vulnerability assessment';
      if (err instanceof Error) {
        errorMessage = err.message;
      } else if (typeof err === 'object' && err !== null && 'message' in err) {
        errorMessage = String(err.message);
      }
      
      error = errorMessage;
      showNotification(errorMessage, 'error');
    } finally {
      loading = false;
    }
  }
  
  // Reset assessment
  function resetAssessment() {
    assessmentResult = null;
    selectedComponentIds = [];
    expandedComponentId = null;
    componentVulnerabilities = [];
  }
  
  // Helper functions
  function selectAll() {
    selectedComponentIds = availableComponents.map(c => c.id);
  }
  
  function deselectAll() {
    selectedComponentIds = [];
  }
  
  // Show component vulnerabilities
  async function toggleComponentVulnerabilities(componentId: string) {
    if (expandedComponentId === componentId) {
      // If already expanded, collapse it
      expandedComponentId = null;
      componentVulnerabilities = [];
      return;
    }
    
    // Expand the component
    isLoadingVulnerabilities = true;
    expandedComponentId = componentId;
    
    try {
      // Find component assessment
      const componentAssessment = assessmentResult?.component_assessments.find(
        a => a.component_id === componentId
      );
      
      if (componentAssessment && componentAssessment.vulnerability_ids.length > 0) {
        console.log('Loading vulnerabilities for component:', componentId);
        console.log('Vulnerability IDs:', componentAssessment.vulnerability_ids);
        
        try {
          // Use Promise.all to fetch individual vulnerability details by ID
          const vulnerabilityPromises = componentAssessment.vulnerability_ids.map(id => 
            getVulnerability(id).catch((error: any) => {
              console.error(`Error fetching vulnerability ${id}:`, error);
              return undefined;
            })
          );
          
          const results = await Promise.all(vulnerabilityPromises);
          componentVulnerabilities = results.filter((v: any): v is Vulnerability => v !== undefined);
          
          console.log('Loaded vulnerabilities:', componentVulnerabilities);
        } catch (innerError) {
          console.error('Error in vulnerability loading:', innerError);
          showNotification('Error loading vulnerability details', 'error');
        }
      } else {
        console.log('No vulnerability IDs found for component:', componentId);
        componentVulnerabilities = [];
      }
    } catch (err) {
      console.error('Error loading vulnerabilities:', err);
    } finally {
      isLoadingVulnerabilities = false;
    }
  }
  
  // Group components by type for easier selection
  $: componentsByType = availableComponents.reduce((groups: Record<string, typeof availableComponents>, component) => {
    const type = component.component_type || 'Other';
    if (!groups[type]) {
      groups[type] = [];
    }
    groups[type].push(component);
    return groups;
  }, {});
</script>

<div class="space-y-8">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-medium" style="color: var(--color-text-main);">Vulnerability Assessment</h2>
    
    {#if assessmentResult}
      <button 
        on:click={resetAssessment}
        class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700"
      >
        Start New Assessment
      </button>
    {/if}
  </div>
  
  {#if error}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
      <strong class="font-bold">Error!</strong>
      <span class="block sm:inline"> {error}</span>
    </div>
  {/if}
  
  {#if !assessmentResult}
    <!-- Component Selection -->
    <div style="background-color: var(--color-card-bg); border: 1px solid var(--color-border);" class="rounded-lg shadow-sm p-6">
      <h3 class="text-lg font-medium mb-4" style="color: var(--color-text-main);">Select Components to Assess</h3>
      
      {#if isLoadingComponents}
        <div class="flex justify-center py-8">
          <Spinner size="md" />
        </div>
      {:else if availableComponents.length === 0}
        <div class="text-center py-6">
          <AlertTriangle class="mx-auto h-12 w-12 text-yellow-400" />
          <h3 class="mt-2 text-sm font-medium">No Components Available</h3>
          <p class="mt-1 text-sm text-gray-500">Create some components first before running an assessment.</p>
        </div>
      {:else}
        <div class="mb-4 flex items-center justify-between">
          <div class="flex gap-2">
            <button
              on:click={selectAll}
              class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50"
            >
              Select All
            </button>
            <button
              on:click={deselectAll}
              class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50"
            >
              Deselect All
            </button>
          </div>
          <div class="text-sm text-gray-500">
            Selected: {selectedComponentIds.length} of {availableComponents.length}
          </div>
        </div>
        
        <div class="border border-gray-200 rounded-md overflow-hidden">
          <div class="max-h-96 overflow-y-auto">
            {#each Object.entries(componentsByType) as [type, components]}
              <div class="border-b border-gray-200 last:border-b-0">
                <div class="bg-gray-50 px-4 py-2 text-sm font-medium text-gray-500">
                  {type}
                </div>
                <div class="divide-y divide-gray-200">
                  {#each components as component}
                    <div class="flex items-center px-4 py-3 hover:bg-gray-50">
                      <input 
                        type="checkbox" 
                        id={`component-${component.id}`} 
                        value={component.id} 
                        bind:group={selectedComponentIds}
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label for={`component-${component.id}`} class="ml-3 block text-sm font-medium text-gray-700">
                        {component.name}
                      </label>
                    </div>
                  {/each}
                </div>
              </div>
            {/each}
          </div>
        </div>
        
        <div class="mt-6">
          <button
            on:click={runAssessment}
            disabled={selectedComponentIds.length === 0 || loading}
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {#if loading}
              <Spinner size="sm" color="white" class_="mr-2" />
              Running Assessment...
            {:else}
              <ShieldAlert class="h-5 w-5 mr-2" />
              Run Vulnerability Assessment
            {/if}
          </button>
        </div>
      {/if}
    </div>
  {:else}
    <!-- Assessment Results -->
    <div style="background-color: var(--color-card-bg); border: 1px solid var(--color-border);" class="rounded-lg shadow-sm p-6">
      <!-- Vulnerability severity charts -->  
      <VulnerabilitySeverityCharts 
        assessmentResult={assessmentResult}
        selectedComponentId={expandedComponentId}
        vulnerabilities={componentVulnerabilities}
      />
      
      <div class="flex items-start mb-6 mt-8">
        <div class="bg-green-100 rounded-full p-2 mr-4">
          <ShieldAlert class="h-6 w-6 text-green-600" />
        </div>
        <div>
          <h3 class="text-lg font-medium" style="color: var(--color-text-main);">Assessment Complete</h3>
          <p class="text-sm text-gray-500 mt-1">Assessment ID: {assessmentResult.assessment_id}</p>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
          <h4 class="text-sm font-medium text-gray-500 mb-1">Total Components</h4>
          <p class="text-2xl font-semibold">{assessmentResult.total_components}</p>
        </div>
        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
          <h4 class="text-sm font-medium text-gray-500 mb-1">Total Vulnerabilities</h4>
          <p class="text-2xl font-semibold">{assessmentResult.total_vulnerabilities}</p>
        </div>
        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
          <h4 class="text-sm font-medium text-gray-500 mb-1">High Severity</h4>
          <p class="text-2xl font-semibold text-red-600">{assessmentResult.high_severity_vulnerabilities}</p>
        </div>
      </div>
      
      {#if assessmentResult.component_assessments && assessmentResult.component_assessments.length > 0}
        <h3 class="text-lg font-medium mb-3" style="color: var(--color-text-main);">Component Results</h3>
        <div class="border border-gray-200 rounded-md overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Component
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Type
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Vulnerabilities
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  High Severity
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {#each assessmentResult.component_assessments as assessment}
                <tr class="hover:bg-gray-50 {expandedComponentId === assessment.component_id ? 'bg-gray-50' : ''}">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <button 
                      on:click={() => toggleComponentVulnerabilities(assessment.component_id)}
                      class="text-blue-600 hover:text-blue-900 hover:underline cursor-pointer"
                    >
                      {assessment.component_name}
                    </button>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {assessment.component_type}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {assessment.total_vulnerabilities}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    {#if assessment.high_severity_vulnerabilities > 0}
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                        {assessment.high_severity_vulnerabilities}
                      </span>
                    {:else}
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        0
                      </span>
                    {/if}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                      on:click={() => toggleComponentVulnerabilities(assessment.component_id)}
                      class="text-blue-600 hover:text-blue-900 inline-flex items-center"
                    >
                      {expandedComponentId === assessment.component_id ? 'Hide Details' : 'View Details'}
                      <ChevronRight class="h-4 w-4 ml-1 {expandedComponentId === assessment.component_id ? 'transform rotate-90 transition-transform' : 'transition-transform'}" />
                    </button>
                  </td>
                </tr>
                {#if expandedComponentId === assessment.component_id}
                  <tr>
                    <td colspan="5" class="p-0">
                      <VulnerabilitySlideDown
                        componentId={assessment.component_id}
                        componentName={assessment.component_name}
                        vulnerabilities={componentVulnerabilities}
                        isLoading={isLoadingVulnerabilities}
                      />
                    </td>
                  </tr>
                {/if}
              {/each}
            </tbody>
          </table>
        </div>
      {/if}
    </div>
  {/if}
  
  <!-- No modal needed, using the slide-down approach instead -->
</div>
