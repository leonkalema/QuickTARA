#!/bin/bash

echo "=== QuickTARA Vulnerability Fix ==="
echo ""

# Step 1: Run the quick fix
echo "Step 1: Running quick fix..."
python quick_fix_vulnerability.py

# Step 2: Run the vulnerability setup if needed
echo ""
echo "Step 2: Checking vulnerability setup..."
if [ -f setup_vulnerability.sh ]; then
    chmod +x setup_vulnerability.sh
    ./setup_vulnerability.sh
else
    echo "setup_vulnerability.sh not found, creating it..."
    cat > setup_vulnerability.sh << 'EOF'
#!/bin/bash
# Setup vulnerability tables in QuickTARA

echo "=== QuickTARA Vulnerability Setup ==="
echo ""

# Check if virtual environment is activated
if [ -z "$VIRTUAL_ENV" ]; then
    echo "WARNING: Virtual environment not activated!"
    echo "Consider activating it with: source .venv/bin/activate"
    echo ""
fi

# Step 1: Create tables
echo "Step 1: Creating vulnerability tables..."
python db_create_vulnerability_tables.py
if [ $? -ne 0 ]; then
    echo "Error creating vulnerability tables"
    exit 1
fi

# Step 2: Add initial data
echo ""
echo "Step 2: Adding sample vulnerability data..."
python add_vulnerability_data.py
if [ $? -ne 0 ]; then
    echo "Error adding vulnerability data"
    exit 1
fi

# Step 3: Verify setup
echo ""
echo "Step 3: Verifying setup..."
python verify_vulnerability_setup.py
if [ $? -ne 0 ]; then
    echo "Verification failed"
    exit 1
fi

echo ""
echo "=== Vulnerability setup completed successfully! ==="
echo "You can now use the vulnerability assessment features in QuickTARA."
EOF
    chmod +x setup_vulnerability.sh
    ./setup_vulnerability.sh
fi

echo ""
echo "=== Fix completed ==="
echo "Try running: python quicktara_web.py --debug"
