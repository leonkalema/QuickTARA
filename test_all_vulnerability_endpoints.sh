#!/bin/bash
# Test all vulnerability API endpoints

BASE_URL="http://localhost:8080/api"

echo "=== QuickTARA Vulnerability API Tests ==="
echo ""

# Test 1: List vulnerabilities
echo "1. Get all vulnerabilities"
curl -X GET "$BASE_URL/vulnerability?skip=0&limit=100"
echo -e "\n"

# Save one vulnerability ID for testing
VULN_ID=$(curl -s "$BASE_URL/vulnerability?skip=0&limit=1" | grep -o '"vulnerability_id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Using vulnerability ID: $VULN_ID"
echo ""

# Test 2: Get a specific vulnerability
echo "2. Get vulnerability $VULN_ID"
curl -X GET "$BASE_URL/vulnerability/$VULN_ID"
echo -e "\n"

# Test 3: Create a new vulnerability
echo "3. Create a new vulnerability"
TIMESTAMP=$(date +%s)
NEW_VULN=$(curl -s -X POST "$BASE_URL/vulnerability" \
  -H "Content-Type: application/json" \
  -d "{
    \"name\": \"Test Vulnerability $TIMESTAMP\",
    \"description\": \"Test vulnerability created at $TIMESTAMP\",
    \"severity\": \"Medium\",
    \"cvss_score\": 6.5,
    \"attack_vector\": \"Network\",
    \"affected_components\": [\"Test Component\"]
  }")
echo "$NEW_VULN"
echo -e "\n"

# Extract the new vulnerability ID
NEW_VULN_ID=$(echo "$NEW_VULN" | grep -o '"vulnerability_id":"[^"]*' | cut -d'"' -f4)
echo "Created vulnerability ID: $NEW_VULN_ID"
echo ""

# Test 4: Update the new vulnerability
echo "4. Update vulnerability $NEW_VULN_ID"
curl -X PUT "$BASE_URL/vulnerability/$NEW_VULN_ID" \
  -H "Content-Type: application/json" \
  -d "{
    \"name\": \"Updated Test Vulnerability $TIMESTAMP\",
    \"severity\": \"High\",
    \"cvss_score\": 8.0
  }"
echo -e "\n"

# Test 5: Get vulnerabilities with severity filter
echo "5. Get vulnerabilities with severity filter (High)"
curl -X GET "$BASE_URL/vulnerability?severity=High"
echo -e "\n"

# Test 6: Perform vulnerability assessment (need valid component IDs)
echo "6. Perform vulnerability assessment"
curl -X POST "$BASE_URL/vulnerability/assess" \
  -H "Content-Type: application/json" \
  -d "[\"ECU001\", \"ECU002\"]"
echo -e "\n"

# Test 7: Delete the created vulnerability
echo "7. Delete vulnerability $NEW_VULN_ID"
curl -X DELETE "$BASE_URL/vulnerability/$NEW_VULN_ID"
echo -e "\n"

# Test 8: Verify deletion
echo "8. Verify vulnerability $NEW_VULN_ID is deleted"
curl -X GET "$BASE_URL/vulnerability/$NEW_VULN_ID"
echo -e "\n"

echo "=== Tests completed ==="
